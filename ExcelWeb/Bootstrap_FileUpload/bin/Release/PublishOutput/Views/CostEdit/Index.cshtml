<script type="text/javascript" src="~/js/bootstrap3-typeahead.min.js"></script>
<!--http://silviomoreto.github.io/bootstrap-select/-->
<link rel="stylesheet" href="~/Scripts/bootstrap-select-1.12.4/css/bootstrap-select.min.css">
<script type="text/javascript" src="~/Scripts/bootstrap-select-1.12.4/js/bootstrap-select.min.js"></script>
<script type="text/javascript" src="~/Scripts/bootstrap-select-1.12.4/js/i18n/defaults-zh_CN.min.js"></script>
<link rel="stylesheet" href="~/js/datetime/css/bootstrap-v2.css">
<link rel="stylesheet" href="~/js/datetime/css/bootstrap-datetimepicker.min.css">
<script src="~/js/datetime/js/bootstrap-datetimepicker.min.js"></script>
<script src="~/js/datetime/locales/bootstrap-datetimepicker.zh-CN.js"></script>
<script type="text/javascript" src="~/Scripts/knockout-3.4.2.js"></script>
<script type="text/javascript" src="~/Scripts/knockout.mapping-latest.js"></script>
<script type="text/javascript" src="~/Scripts/knockout.bootstraptable.js"></script>
<script type="text/javascript" src="~/Scripts/knockout.index.js"></script>
<style type="text/css">
    body {
        padding-top: 60px;
        padding-bottom: 40px;
    }

    .nav li {
        padding-top: 5px;
    }

    .sidebar-nav {
        padding: 9px 0;
    }

    .leaderboard {
        padding: 60px;
        margin-bottom: 30px;
        background-image: url('/twitter-bootstrap/images/gridbg.gif');
        background-repeat: repeat;
        -webkit-border-radius: 6px;
        -moz-border-radius: 6px;
        border-radius: 6px;
    }

        .leaderboard h1 {
            font-size: 40px;
            margin-bottom: 5px;
            line-height: 1;
            letter-spacing: -1px;
            color: #92B901;
        }

        .leaderboard p {
            font-size: 18px;
            font-weight: 200;
            line-height: 27px;
        }

    .well {
        background-image: url('/twitter-bootstrap/images/gridbg.gif');
        background-repeat: repeat;
        -webkit-border-radius: 6px;
        -moz-border-radius: 6px;
        border-radius: 6px;
    }

    .nav .nav-header {
        font-size: 18px;
        color: #92B901;
    }

    .fade {
        opacity: 0;
        -webkit-transition: opacity .15s linear;
        -o-transition: opacity .15s linear;
        transition: opacity .15s linear;
    }

        .fade.in {
            opacity: 1;
        }

    .modal-open {
        overflow: hidden;
    }

    .modal.fade .modal-dialog {
        -webkit-transition: -webkit-transform .3s ease-out;
        -o-transition: -o-transform .3s ease-out;
        transition: transform .3s ease-out;
        -webkit-transform: translate(0, -25%);
        -ms-transform: translate(0, -25%);
        -o-transform: translate(0, -25%);
        transform: translate(0, -25%);
    }

    .modal.in .modal-dialog {
        -webkit-transform: translate(0, 0);
        -ms-transform: translate(0, 0);
        -o-transform: translate(0, 0);
        transform: translate(0, 0);
    }

    .modal-open .modal {
        overflow-x: hidden;
        overflow-y: auto;
    }

    .modal-dialog {
        position: relative;
        width: auto;
        margin: 10px;
    }

    .modal-content {
        position: relative;
        background-color: #fff;
        -webkit-background-clip: padding-box;
        background-clip: padding-box;
        border: 1px solid #999;
        border: 1px solid rgba(0, 0, 0, .2);
        border-radius: 6px;
        outline: 0;
        -webkit-box-shadow: 0 3px 9px rgba(0, 0, 0, .5);
        box-shadow: 0 3px 9px rgba(0, 0, 0, .5);
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1040;
        background-color: #000;
    }

        .modal-backdrop.fade {
            filter: alpha(opacity=0);
            opacity: 0;
        }

        .modal-backdrop.in {
            filter: alpha(opacity=50);
            opacity: .5;
        }

    .modal-header {
        min-height: 16.42857143px;
        padding: 15px;
        border-bottom: 1px solid #e5e5e5;
    }

        .modal-header .close {
            margin-top: -2px;
        }

    .modal-title {
        margin: 0;
        line-height: 1.42857143;
    }

    .modal-body {
        position: relative;
        padding: 15px;
    }

    .modal-footer {
        padding: 15px;
        text-align: right;
        border-top: 1px solid #e5e5e5;
    }

        .modal-footer .btn + .btn {
            margin-bottom: 0;
            margin-left: 5px;
        }

        .modal-footer .btn-group .btn + .btn {
            margin-left: -1px;
        }

        .modal-footer .btn-block + .btn-block {
            margin-left: 0;
        }

    .modal-scrollbar-measure {
        position: absolute;
        top: -9999px;
        width: 50px;
        height: 50px;
        overflow: scroll;
    }

    .col-center-block {
        float: none;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }
</style>

<script type="text/javascript">
    var vendorName = '@{ @ViewBag.VendorName}';
</script>
<!--http://www.cnblogs.com/landeanfen/p/5400654.html-->
<div class="container body-content">
    <div class="panel panel-default">
        <div class="panel-heading"></div>
        <div class="panel-heading">客户预收款明细</div>
        <div class="panel-heading">
            <div id="toolbar" class="btn-group">
                <button id="btn_add" type="button" class="btn btn-default">
                    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>新增
                </button>
                <button id="btn_edit" type="button" class="btn btn-default">
                    <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>修改
                </button>
                <button id="btn_delete" type="button" class="btn btn-default">
                    <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>删除
                </button>
            </div>
            <table id="tb_dept" data-bind="myBootstrapTable:$root">
                <thead>
                    <tr>
                        <th data-checkbox="true"></th>
                        <th data-field="ID">ID</th>
                        <th data-field="VENDOR">客户名称</th>
                        <th data-field="MONEY_ADVANCE">预收金额</th>
                        <th data-field="DATE_STR">更新时间</th>
                        <th data-field="NOTES">备注</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
    <div class="modal fade" id="myModal" style="width:460px;" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">操作</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <input type="hidden" name="txt_ID" class="form-control" id="txt_ID">
                    </div>
                    <div class="form-group">
                        <label for="txt_VENDOR">客户名称</label>
                        <input type="text" name="txt_VENDOR" class="form-control" id="txt_VENDOR">
                    </div>
                    <div class="form-group">
                        <label for="txt_MONEY_ADVANCE">预收金额</label>
                        <input type="text" name="txt_MONEY_ADVANCE" class="form-control" id="txt_MONEY_ADVANCE">
                    </div>
                    <div class="form-group">
                        <label for="txt_DATE_STR">更新时间</label>
                        <div class="controls input-append date form_date" style="height:30px" data-date="" data-date-format="yyyy-mm-dd" data-link-field="start_date" data-link-format="yyyy-mm-dd">
                            <input size="24" style="height:26px" type="text" value="" readonly>
                            <span class="add-on" style="height:26px"><i class="icon-remove"></i></span>
                            <span class="add-on" style="height:26px"><i class="icon-th"></i></span>
                        </div>
                        <input type="hidden" id="start_date" value="" />
                    </div>
                    <div class="form-group">
                        <label for="txt_NOTES">备注</label>
                        <input type="text" multiple name="txt_NOTES" class="form-control" id="txt_NOTES">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span>关闭</button>
                    <button type="button" id="btn_submit" class="btn btn-primary" data-dismiss="modal"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span>保存</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 模态弹出窗内容 -->
<div class="modal" id="y-myModalAdd" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">×</span>
                    <span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title">提示</h4>
            </div>
            <div class="modal-body" id="showMsg">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">确认</button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    $(function () {
        //1、初始化表格
        tableInit.Init();

        //2、注册增删改事件
        operate.operateInit();
    });

    var action = "ADD";

    //初始化表格
    var tableInit = {
        Init: function () {
            //绑定table的viewmodel
            this.myViewModel = new ko.bootstrapTableViewModel({
                url: url_p + '/CostEdit/GetCostDetail',         //请求后台的URL（*）
                method: 'get',                      //请求方式（*）
                //toolbar: '#toolbar',                //工具按钮用哪个容器
                queryParams: function (param) {
                    return { limit: param.limit, offset: param.offset, vendorName: vendorName };
                },//传递参数（*）
                pagination: true,                   //是否显示分页（*）
                sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
                pageNumber: 1,                      //初始化加载第一页，默认第一页
                pageSize: 100,                       //每页的记录行数（*）
                pageList: [10, 25, 50, 100]        //可供选择的每页的行数（*）
            });
            ko.applyBindings(this.myViewModel, document.getElementById("tb_dept"));
        }
    };

    //操作
    var operate = {
        //初始化按钮事件
        operateInit: function () {
            this.operateAdd();
            this.operateUpdate();
            this.operateDelete();
            this.DepartmentModel = {
                ID: ko.observable(),
                VENDOR: ko.observable(),
                MONEY_ADVANCE: ko.observable(),
                DATE_STR: ko.observable(),
                NOTES: ko.observable()
            };
        },
        //新增
        operateAdd: function () {
            $('#btn_add').on("click", function () {
                $('#txt_VENDOR').val(vendorName);
                $('#txt_VENDOR').attr("readonly", "readonly");
                action = "ADD";

                $('.form_date').datetimepicker({
                    language: 'zh-CN',
                    weekStart: 1,
                    todayBtn: 1,
                    autoclose: 1,
                    todayHighlight: 1,
                    startView: 2,
                    minView: 2,
                    forceParse: 0
                });

                $("#myModal").modal().on("shown.bs.modal", function () {
                    var oEmptyModel = {
                        ID: ko.observable(),
                        VENDOR: ko.observable(),
                        MONEY_ADVANCE: ko.observable(),
                        DATE_STR: ko.observable(),
                        NOTES: ko.observable()
                    };
                    ko.utils.extend(operate.DepartmentModel, oEmptyModel);
                    ko.applyBindings(operate.DepartmentModel, document.getElementById("myModal"));
                    operate.operateSave();
                }).on('hidden.bs.modal', function () {
                    ko.cleanNode(document.getElementById("myModal"));
                });
            });
        },
        //编辑
        operateUpdate: function () {
            $('#btn_edit').on("click", function () {
                var arrselectedData = tableInit.myViewModel.getSelections();
                if (!operate.operateCheck(arrselectedData)) { return; }
                action = "UPDATE";
                var oEmptyModel = {
                    ID: ko.observable(),
                    VENDOR: ko.observable(),
                    MONEY_ADVANCE: ko.observable(),
                    DATE_STR: ko.observable(),
                    NOTES: ko.observable()
                };

                $('.form_date').datetimepicker({
                    language: 'zh-CN',
                    weekStart: 1,
                    todayBtn: 1,
                    autoclose: 1,
                    todayHighlight: 1,
                    startView: 2,
                    minView: 2,
                    forceParse: 0
                });
                $("#myModal").modal().on("shown.bs.modal", function () {

                    //将选中该行数据有数据Model通过Mapping组件转换为viewmodel
                    //var oEmptyModel = ko.mapping.fromJS(arrselectedData[0]);
                    ko.utils.extend(operate.DepartmentModel, oEmptyModel);
                    ko.applyBindings(operate.DepartmentModel, document.getElementById("myModal"));
                    $("#txt_ID").attr('value', arrselectedData[0].ID);
                    $("#txt_VENDOR").attr('value', arrselectedData[0].VENDOR);
                    $("#txt_MONEY_ADVANCE").attr('value', arrselectedData[0].MONEY_ADVANCE);
                    $("#txt_NOTES").attr('value', arrselectedData[0].NOTES);
                    
                    operate.operateSave();
                }).on('hidden.bs.modal', function () {
                    //关闭弹出框的时候清除绑定(这个清空包括清空绑定和清空注册事件)
                    ko.cleanNode(document.getElementById("myModal"));
                });
            });
        },
        //删除
        operateDelete: function () {
            $('#btn_delete').on("click", function () {
                var arrselectedData = tableInit.myViewModel.getSelections();
                $.ajax({
                    url: url_p + "/CostEdit/Delete",
                    type: "post",
                    contentType: 'application/json',
                    data: JSON.stringify(arrselectedData),
                    success: function (data, status) {
                        var $modal = $('#y-myModalAdd');
                        $modal.modal({ backdrop: 'static' });
                        $("#showMsg").html(data);
                        tableInit.myViewModel.refresh();
                    }
                });
            });
        },
        //保存数据
        operateSave: function () {
            $('#btn_submit').on("click", function () {
                //取到当前的viewmodel
                var oViewModel = operate.DepartmentModel;
                operate.DepartmentModel.VENDOR($("#txt_VENDOR").val());
                operate.DepartmentModel.MONEY_ADVANCE($("#txt_MONEY_ADVANCE").val());
                operate.DepartmentModel.DATE_STR($("#start_date").val());
                operate.DepartmentModel.NOTES($("#txt_NOTES").val());
                operate.DepartmentModel.ID($("#txt_ID").val());
                //将Viewmodel转换为数据model
                var oDataModel = ko.toJS(oViewModel);
                var funcName = action;

                $.ajax({
                    url: url_p + "/CostEdit/" + funcName,
                    type: "post",
                    data: oDataModel,
                    success: function (data, status) {
                        var $modal = $('#y-myModalAdd');
                        $modal.modal({ backdrop: 'static' });
                        $("#showMsg").html(data);
                        tableInit.myViewModel.refresh();
                        location = location;
                    }
                });
            });
        },
        //数据校验
        operateCheck: function (arr) {
            if (arr.length <= 0) {
                alert("请至少选择一行数据");
                return false;
            }
            if (arr.length > 1) {
                alert("只能编辑一行数据");
                return false;
            }
            return true;
        }
    }
</script>
<script type="text/javascript">
    $('.form_date').datetimepicker({
        language: 'zh-CN',
        weekStart: 1,
        todayBtn: 1,
        autoclose: 1,
        todayHighlight: 1,
        startView: 2,
        minView: 2,
        forceParse: 0
    });
</script>